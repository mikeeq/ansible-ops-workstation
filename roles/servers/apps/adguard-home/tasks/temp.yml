---
- debug:
    var: dhcp | map(attribute='ip')

- set_fact:
    dhcp_diff: >-
        {{
          dhcp_config.static_leases
          | difference(
              dhcp
            )
        }}

- debug:
    var: dhcp_diff

- debug:
    msg: "{{ dhcp_config.static_leases | selectattr('mac','equalto',item['mac']) | map(attribute='hostname') | default('N/A') }}"
  vars:
    item:
      hostname: xbox-one-x1
      mac: 28:16:a8:c4:fa:62
      ip: 192.168.1.43

- debug:
    msg: "old_entry_ip: {{old_entry_ip}}, old_entry_hostname: {{old_entry_hostname}}"
  when: old_entry_ip != item.ip or old_entry_hostname != item.hostname
  vars:
    old_entry_ip: "{{ dhcp_config.static_leases | selectattr('mac','equalto',item['mac']) | map(attribute='ip') | first | default('N/A') }}"
    old_entry_hostname: "{{ dhcp_config.static_leases | selectattr('mac','equalto',item['mac']) | map(attribute='hostname') | first | default('N/A') }}"
  loop: "{{ dhcp }}"

- set_fact:
    dhcp_to_delete: "{{ dhcp_to_delete + entry }}"
  when:
    - (old_entry_ip != item.ip and old_entry_ip != 'N/A') or (old_entry_hostname != item.hostname and old_entry_hostname != 'N/A')
  vars:
    old_entry_ip: "{{ dhcp_config.static_leases | selectattr('mac','equalto',item['mac']) | map(attribute='ip') | first | default('N/A') }}"
    old_entry_hostname: "{{ dhcp_config.static_leases | selectattr('mac','equalto',item['mac']) | map(attribute='hostname') | first | default('N/A') }}"
    entry: >-
      [
        {
          'hostname': '{{ old_entry_hostname }}',
          'ip': '{{ old_entry_ip }}',
          'mac': '{{ item.mac }}'
        }
      ]
  loop: "{{ dhcp }}"

# https://www.reddit.com/r/ansible/comments/lhhi14/compare_two_unordered_lists_of_dictionaries/

# - debug:
#     var: >-
#       {{
#         dhcp_config.static_leases
#           | difference(
#             dhcp | map(attribute='ip')
#           )
#       }}
