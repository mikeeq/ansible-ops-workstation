---
- name: JENKINS-PASSTOKEN | Get initial authentication token
  shell: 'cat {{ jenkins_home }}/secrets/initialAdminPassword'
  register: admin_auth_token

- name: JENKINS-CTEDENTIALS | Create CRUMB authentication request
  uri:
    url: 'http://localhost:{{ jenkins_host_port }}/crumbIssuer/api/xml?xpath=concat(//crumbRequestField,":",//crumb)'
    user: admin
    password: '{{ admin_auth_token.stdout }}'
    force_basic_auth: yes
    return_content: yes
  register: crumb
  no_log: true

- name: JENKINS-CTEDENTIALS | Add Jenkins administration account
  uri:
    method: POST
    url: 'http://localhost:{{ jenkins_host_port }}/securityRealm/createAccountByAdmin'
    user: admin
    password: '{{ admin_auth_token.stdout }}'
    force_basic_auth: yes
    follow_redirects: all
    headers:
      Jenkins-Crumb: '{{ crumb.content.split(":")[1] }}'
      Cookie: '{{ crumb.set_cookie }}'
    body: 'username={{ item.name }}&password1={{ item.password }}&password2={{ item.password }}&fullname={{ item.name }}&email={{ item.email }}'
  loop: "{{ jenkins_users }}"
  loop_control:
    label: "{{ item.name }}"
  # no_log: true
