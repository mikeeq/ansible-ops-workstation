---
- name: Get installed plugins version
  become: true
  become_user: "{{ user_name }}"
  shell: basename $(find ~/.vagrant.d | grep -i '{{ item }}-[[:digit:]]' | grep -i specifications | grep -i gemspec | head -n 1) .gemspec | rev | cut -d'-' -f1 | rev
  register: installed_vagrant_plugins_version
  changed_when: false
  ignore_errors: true
  loop: "{{ vagrant_plugins }}"

- name: Get latest plugins version
  become: true
  become_user: "{{ user_name }}"
  shell: curl -Ls https://rubygems.org/gems/{{ item }} | grep -i versions | grep -i gems | grep -i item | head -n 1 | cut -d'>' -f2 | cut -d'<' -f1
  register: latest_vagrant_plugins_version
  changed_when: false
  ignore_errors: true
  loop: "{{ vagrant_plugins }}"

- name: Get installed embedded plugins version
  become: true
  shell: basename $(find /opt/vagrant | grep -i '{{ item }}-[[:digit:]]' | grep -i specifications | grep -i gemspec | head -n 1) .gemspec | rev | cut -d'-' -f1 | rev
  register: installed_vagrant_embedded_plugins_version
  changed_when: false
  ignore_errors: true
  loop: "{{ vagrant_embedded_plugins }}"

- name: Get latest embedded plugins version
  become: true
  become_user: "{{ user_name }}"
  shell: curl -Ls https://rubygems.org/gems/{{ item }} | grep -i versions | grep -i gems | grep -i item | head -n 1 | cut -d'>' -f2 | cut -d'<' -f1
  register: latest_vagrant_embedded_plugins_version
  changed_when: false
  ignore_errors: true
  loop: "{{ vagrant_embedded_plugins }}"

- debug:
    var: installed_vagrant_embedded_plugins_version

- debug:
    var: latest_vagrant_embedded_plugins_version

- set_fact:
    vagrant_latest_plugins_info: >-
      {{ vagrant_latest_plugins_info | default([]) +
        [
          {
            'name': item.name,
            'id': item.id,
          }
        ]
      }}
  loop:
    - "{{ latest_vagrant_embedded_plugins_version.results }}"
    - "{{ latest_vagrant_plugins_version.results }}"

- set_fact:
    vagrant_installed_plugins_info: >-
      {{ vagrant_installed_plugins_info | default([]) +
        [
          {
            'name': item.item,
            'version': item.stdout,
          }
        ]
      }}
  loop:
    - "{{ installed_vagrant_embedded_plugins_version.results }}"
    - "{{ installed_vagrant_plugins_version.results }}"

- debug:
    var: vagrant_installed_plugins_info
