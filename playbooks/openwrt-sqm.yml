---
# - name: Init openwrt ansible support
#   hosts:
#     - openwrt
#   become: true
#   gather_facts: false
#   tasks:
#     - raw: uname -a
#     - raw: opkg install {{ opkgs | join(' ') }}
#       vars:
#         opkgs:
#           - python3-light
#           - python3-multiprocessing
#           - python3-distutils
#           - openssh-sftp-server
#           - python3-logging
#           - python3-urllib

- name: Setup routers
  hosts:
    - openwrt
  become: true
  gather_facts: true
  tasks:
    - name: Set vars to enable SQM
      set_fact:
        cake_service: "start"
        sqm_enabled: "1"
      when: sqm_pipeline
    - name: Set vars to disable SQM
      set_fact:
        cake_service: "stop"
        sqm_enabled: "0"
      when: sqm_pipeline == false

    - name: Change config SQM
      lineinfile:
        regexp: 'option\senabled'
        # \s{8}option\senabled\s.\d.
        line: "        option enabled '{{ sqm_enabled }}'"
        path: /etc/config/sqm
      register: sqm_config

    - name: Restart SQM service
      shell: service sqm restart
      when: sqm_config.changed

    - name: Check Dynamic SQM service status
      shell: service cake-autorate status
      register: dynamic_sqm_status

    - name: "{{ sqm_enabled }} Dynamic SQM service"
      shell: service cake-autorate {{ cake_service }}
      when: (dynamic_sqm_status.stdout == "running" and cake_service == "stop") or (dynamic_sqm_status == "inactive" and cake_service == "start")

# - python3-light
# - python3-multiprocessing
# - python3-distutils
# - openssh-sftp-server
# - python3-logging
# - python3-urllib

# Clean
# root@AX3200Mikee:~# df -h
# Filesystem                Size      Used Available Use% Mounted on
# /dev/ubi0_1              90.4M      2.4M     83.4M   3% /overlay

# python3-light
# /dev/ubi0_1              90.4M      7.3M     78.4M   9% /overlay

# python3-multiprocessing
# /dev/ubi0_1              90.4M      7.7M     78.0M   9% /overlay

# python3-distutils
# /dev/ubi0_1              90.4M      8.7M     77.0M  10% /overlay

# openssh-sftp-server
# /dev/ubi0_1              90.4M     12.1M     73.6M  14% /overlay

# python3-logging
# /dev/ubi0_1              90.4M     11.7M     74.0M  14% /overlay

# python3-urllib
# /dev/ubi0_1              90.4M      9.3M     76.4M  11% /overlay
